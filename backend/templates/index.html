<!DOCTYPE html>
<html lang="zh-CN" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoGen Studio Lite</title>
    <!-- Tailwind + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Markdown-it -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.0.0/dist/markdown-it.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        [v-cloak] { display: none; }
        .markdown-body p { margin-bottom: 0.5em; }
        .markdown-body pre { background-color: #2d2d2d; color: #ccc; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .chat-bubble.markdown-body { max-width: 100%; overflow-x: hidden; }
        /* Error overlay */
        #error-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; padding: 20px; color: red; overflow: auto; }
    </style>
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const overlay = document.getElementById('error-overlay');
            if (overlay) {
                overlay.style.display = 'block';
                overlay.innerHTML += `<h3>Error Detected:</h3><pre>${msg}\nAt: ${url}:${line}:${col}\nStack: ${error?.stack}</pre><hr>`;
            }
            return false;
        };
    </script>
</head>
<body class="bg-base-200 h-screen overflow-hidden text-base-content">
    <div id="error-overlay"></div>
    
    <div id="app" v-cloak class="flex h-full w-full">
        
        <!-- Sidebar: Navigation & Agents -->
        <div class="w-80 bg-base-100 border-r border-base-300 flex flex-col shadow-xl z-10">
            <div class="p-4 border-b border-base-300 bg-primary text-primary-content flex items-center gap-2">
                <i class="fa-solid fa-robot text-2xl"></i>
                <div>
                    <h1 class="font-bold text-lg">AutoGen Studio</h1>
                    <p class="text-xs opacity-80">Multi-Agent Orchestration</p>
                </div>
            </div>

            <!-- Tab Switcher -->
            <div class="tabs tabs-boxed m-2 bg-base-200">
                <a class="tab flex-1" :class="{'tab-active': currentTab === 'chat'}" @click="currentTab = 'chat'">
                    <i class="fa-solid fa-comments mr-2"></i> 对话
                </a>
                <a class="tab flex-1" :class="{'tab-active': currentTab === 'agents'}" @click="currentTab = 'agents'">
                    <i class="fa-solid fa-users-gear mr-2"></i> 智能体
                </a>
            </div>

            <!-- Agents List (Selectable for Chat) -->
            <div v-show="currentTab === 'chat'" class="flex-1 overflow-y-auto p-2">
                <div class="flex items-center justify-between px-2 mb-2">
                    <div class="text-xs font-bold text-base-content/50 uppercase">选择参与的智能体</div>
                    <button @click="toggleSelectAll" class="btn btn-xs btn-ghost text-xs">
                        {{ selectedAgentIds.length === agents.length ? '取消全选' : '全选' }}
                    </button>
                </div>
                <div v-if="loadingAgents" class="flex justify-center p-4"><span class="loading loading-spinner"></span></div>
                <div v-else class="space-y-2">
                    <label v-for="agent in agents" :key="agent.id" 
                           class="flex items-center p-3 rounded-lg hover:bg-base-200 cursor-pointer border border-transparent hover:border-base-300 transition-all"
                           :class="{'bg-primary/10 border-primary': selectedAgentIds.includes(agent.id)}">
                        <input type="checkbox" :value="agent.id" v-model="selectedAgentIds" class="checkbox checkbox-primary checkbox-sm mr-3" />
                        <div class="flex-1">
                            <div class="font-bold">{{ agent.name }}</div>
                            <div class="text-xs opacity-60 truncate">{{ agent.config?.description || 'No description' }}</div>
                        </div>
                    </label>
                    <div v-if="agents.length === 0" class="text-center p-4 opacity-50 text-sm">
                        暂无智能体，请先去配置
                    </div>
                </div>
            </div>

             <!-- Agents Management List -->
             <div v-show="currentTab === 'agents'" class="flex-1 overflow-y-auto p-2">
                <div class="space-y-3">
                    <div v-for="agent in agents" :key="agent.id" class="card bg-base-100 shadow-sm border border-base-200 compact group">
                        <div class="card-body p-4">
                            <div class="flex justify-between items-start">
                                <h3 class="card-title text-base">{{ agent.name }}</h3>
                                <div class="flex gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button @click="duplicateAgent(agent)" class="btn btn-ghost btn-xs text-secondary" title="复制智能体"><i class="fa-solid fa-copy"></i></button>
                                    <button @click="editAgent(agent)" class="btn btn-ghost btn-xs text-info" title="编辑"><i class="fa-solid fa-pen"></i></button>
                                    <button @click="deleteAgent(agent.id)" class="btn btn-ghost btn-xs text-error" title="删除"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                            <p class="text-xs opacity-70 line-clamp-2">{{ agent.system_message }}</p>
                            <div class="mt-2 flex flex-wrap gap-1">
                                <span class="badge badge-xs badge-outline">{{ agent.config?.human_input_mode || 'NEVER' }}</span>
                                <span class="badge badge-xs badge-outline">Temp: {{ agent.config?.temperature || 0.7 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openCreateModal" class="btn btn-primary w-full mt-4">
                    <i class="fa-solid fa-plus"></i> 新建智能体
                </button>
             </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col bg-base-100 relative">
            
            <!-- Chat View -->
            <div v-show="currentTab === 'chat'" class="flex-1 flex flex-col h-full">
                <!-- Chat Header -->
                <div class="navbar bg-base-100 border-b border-base-200 px-4 min-h-[4rem]">
                    <div class="flex-1">
                        <span class="font-bold text-lg">Group Chat</span>
                        <span class="ml-2 text-sm opacity-50" v-if="selectedAgentIds.length > 0">
                            ({{ selectedAgentIds.length }} Agents Active)
                        </span>
                    </div>
                    <div class="flex-none">
                        <button @click="clearChat" class="btn btn-ghost btn-sm text-error" title="清空对话">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4" ref="chatContainer">
                    <div v-if="messages.length === 0" class="flex flex-col items-center justify-center h-full text-base-content/30">
                        <i class="fa-solid fa-comments text-6xl mb-4"></i>
                        <p>选择智能体并开始对话</p>
                    </div>
                    
                    <div v-for="(msg, index) in messages" :key="index" class="chat" 
                         :class="msg.role === 'user' ? 'chat-end' : 'chat-start'">
                        <div class="chat-header opacity-50 text-xs mb-1">
                            {{ msg.name || msg.role }} <time class="text-[10px] ml-1">{{ formatTime(msg.timestamp) }}</time>
                        </div>
                        <div class="chat-bubble shadow-md" 
                             :class="{'chat-bubble-primary': msg.role === 'user', 'chat-bubble-secondary': msg.role !== 'user'}">
                            <div class="markdown-body text-sm" v-html="renderMarkdown(msg.content)"></div>
                        </div>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div v-if="isSending" class="chat chat-start">
                        <div class="chat-header opacity-50 text-xs">System</div>
                        <div class="chat-bubble chat-bubble-secondary animate-pulse">
                            <span class="loading loading-dots loading-sm"></span> Agents are thinking...
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 bg-base-100 border-t border-base-200">
                    <div class="flex gap-2">
                        <textarea v-model="userInput" @keydown="handleKeydown"
                                  placeholder="Type your message here... (Enter to send, Shift+Enter for new line)" 
                                  class="textarea textarea-bordered flex-1 resize-none h-14 focus:outline-none leading-normal py-2"></textarea>
                        <button @click="sendMessage" :disabled="isSending || !userInput.trim() || selectedAgentIds.length === 0" 
                                class="btn btn-primary h-14 w-20">
                            <i v-if="!isSending" class="fa-solid fa-paper-plane"></i>
                            <span v-else class="loading loading-spinner"></span>
                        </button>
                    </div>
                    <div v-if="selectedAgentIds.length === 0" class="text-error text-xs mt-1">
                        * 请至少选择一个智能体参与对话
                    </div>
                </div>
            </div>

            <!-- Agents Config View (Empty State for right side when in Agents tab) -->
            <div v-show="currentTab === 'agents'" class="flex-1 flex items-center justify-center bg-base-200/50">
                <div class="text-center opacity-40">
                    <i class="fa-solid fa-arrow-left text-4xl mb-4"></i>
                    <p>在左侧管理您的智能体</p>
                </div>
            </div>

        </div>

        <!-- Create/Edit Agent Modal -->
        <dialog id="agent_modal" class="modal">
            <div class="modal-box w-11/12 max-w-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">{{ isEditing ? '编辑智能体' : '新建智能体' }}</h3>
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-xs btn-outline">快速模板</div>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                            <li v-for="(tpl, name) in templates" :key="name">
                                <a @click="applyTemplate(tpl)">{{ name }}</a>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Basic Info -->
                    <div class="form-control md:col-span-2">
                        <label class="label"><span class="label-text">Name (唯一标识)</span></label>
                        <input type="text" v-model="form.name" placeholder="e.g. Coder, Writer" class="input input-bordered w-full" />
                    </div>

                    <div class="form-control md:col-span-2">
                        <label class="label"><span class="label-text">Description (用于 GroupChat 路由)</span></label>
                        <input type="text" v-model="form.config.description" placeholder="Describes what this agent can do..." class="input input-bordered w-full" />
                    </div>
                    
                    <div class="form-control md:col-span-2">
                        <label class="label"><span class="label-text">System Message (核心人设)</span></label>
                        <textarea v-model="form.system_message" class="textarea textarea-bordered h-24" placeholder="You are a helpful AI assistant..."></textarea>
                    </div>

                    <!-- Advanced Config -->
                    <div class="divider md:col-span-2 text-xs opacity-50">高级配置</div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">Human Input Mode</span></label>
                        <select v-model="form.config.human_input_mode" class="select select-bordered w-full">
                            <option value="NEVER">NEVER (全自动)</option>
                            <option value="TERMINATE">TERMINATE (结束时询问)</option>
                            <option value="ALWAYS">ALWAYS (总是询问 - Web端慎用)</option>
                        </select>
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">Max Auto Reply</span></label>
                        <input type="number" v-model.number="form.config.max_consecutive_auto_reply" class="input input-bordered w-full" />
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">Temperature ({{ form.config.temperature }})</span></label>
                        <input type="range" min="0" max="1" step="0.1" v-model.number="form.config.temperature" class="range range-primary range-xs" />
                    </div>

                    <div class="form-control">
                        <label class="label"><span class="label-text">Model</span></label>
                        <select class="select select-bordered w-full" disabled>
                            <option selected>deepseek-chat</option>
                        </select>
                    </div>
                </div>

                <div class="modal-action">
                    <form method="dialog">
                        <button class="btn" @click="closeModal">取消</button>
                        <button class="btn btn-primary ml-2" @click.prevent="saveAgent">保存</button>
                    </form>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>

        <!-- Toast Notification -->
        <div v-if="toast.show" class="toast toast-top toast-center z-50">
            <div class="alert" :class="toast.type === 'error' ? 'alert-error' : 'alert-success'">
                <span>{{ toast.message }}</span>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, onMounted, computed, nextTick } = Vue;
        // Check if dependencies loaded
        if (!window.Vue || !window.axios || !window.markdownit) {
            document.getElementById('error-overlay').style.display = 'block';
            document.getElementById('error-overlay').innerHTML = '<h3>Critical Error: Dependencies failed to load. Please check your internet connection.</h3>';
            throw new Error('Dependencies missing');
        }

        const md = window.markdownit();

        // API Configuration
        const getApiBase = () => {
            const hostname = window.location.hostname;
            if (hostname === '127.0.0.1' || hostname === 'localhost') {
                return '/api';
            }
            // 生产环境 Render 后端地址
            return 'https://autogen-demo-4tl4.onrender.com/api';
        };
        const API_BASE = getApiBase();

        createApp({
            setup() {
                // State
                const currentTab = ref('chat'); // 'chat' or 'agents'
                const agents = ref([]);
                const selectedAgentIds = ref([]);
                const messages = ref([]);
                const userInput = ref('');
                const isSending = ref(false);
                const loadingAgents = ref(false);
                const isEditing = ref(false);
                
                // Form State
                const form = ref({
                    id: null,
                    name: '',
                    system_message: '',
                    config: {
                        description: '',
                        human_input_mode: 'NEVER',
                        max_consecutive_auto_reply: 10,
                        temperature: 0.7
                    }
                });

                // Toast State
                const toast = ref({ show: false, message: '', type: 'info' });

                // Refs
                const chatContainer = ref(null);

                // Methods
                const showToast = (msg, type = 'info') => {
                    toast.value = { show: true, message: msg, type };
                    setTimeout(() => toast.value.show = false, 3000);
                };

                const fetchAgents = async () => {
                    loadingAgents.value = true;
                    try {
                        const res = await axios.get(`${API_BASE}/agents`);
                        agents.value = res.data;
                        // 默认选中所有 agents
                        if (selectedAgentIds.value.length === 0) {
                            selectedAgentIds.value = agents.value.map(a => a.id);
                        }
                    } catch (e) {
                        showToast('Failed to load agents: ' + e.message, 'error');
                        console.error(e);
                    } finally {
                        loadingAgents.value = false;
                    }
                };

                const openCreateModal = () => {
                    isEditing.value = false;
                    form.value = {
                        id: null,
                        name: '',
                        system_message: '',
                        config: {
                            description: '',
                            human_input_mode: 'NEVER',
                            max_consecutive_auto_reply: 10,
                            temperature: 0.7
                        }
                    };
                    document.getElementById('agent_modal').showModal();
                };

                const editAgent = (agent) => {
                    isEditing.value = true;
                    form.value = JSON.parse(JSON.stringify(agent)); // Deep copy
                    // Ensure config object exists
                    if (!form.value.config) {
                        form.value.config = {
                            description: '',
                            human_input_mode: 'NEVER',
                            max_consecutive_auto_reply: 10,
                            temperature: 0.7
                        };
                    }
                    document.getElementById('agent_modal').showModal();
                };

                const closeModal = () => {
                    document.getElementById('agent_modal').close();
                };

                const saveAgent = async () => {
                    if (!form.value.name) {
                        showToast('Name is required', 'error');
                        return;
                    }

                    try {
                        if (isEditing.value) {
                            await axios.delete(`${API_BASE}/agents/${form.value.id}`);
                        }
                        
                        await axios.post(`${API_BASE}/agents`, form.value);
                        showToast(isEditing.value ? 'Agent updated' : 'Agent created', 'success');
                        closeModal();
                        fetchAgents();
                    } catch (e) {
                        showToast('Error saving agent: ' + e.message, 'error');
                    }
                };

                const deleteAgent = async (id) => {
                    if (!confirm('Are you sure you want to delete this agent?')) return;
                    try {
                        await axios.delete(`${API_BASE}/agents/${id}`);
                        showToast('Agent deleted', 'success');
                        fetchAgents();
                    } catch (e) {
                        showToast('Error deleting agent: ' + e.message, 'error');
                    }
                };

                const sendMessage = async () => {
                    if (!userInput.value.trim() || isSending.value) return;
                    if (selectedAgentIds.value.length === 0) {
                        showToast('Please select at least one agent', 'error');
                        return;
                    }

                    const text = userInput.value;
                    userInput.value = '';
                    
                    // Optimistic UI update
                    messages.value.push({
                        role: 'user',
                        name: 'You',
                        content: text,
                        timestamp: new Date().toISOString()
                    });

                    isSending.value = true;
                    scrollToBottom();

                    try {
                        const res = await axios.post(`${API_BASE}/chat`, {
                            message: text,
                            agent_ids: selectedAgentIds.value
                        });
                        
                        if (res.data.messages && Array.isArray(res.data.messages)) {
                            const newMessages = res.data.messages.filter((m, idx) => {
                                return !(m.role === 'user' && m.content === text);
                            });
                            messages.value.push(...newMessages);
                        }
                    } catch (e) {
                        messages.value.push({
                            role: 'system',
                            content: 'Error: ' + (e.response?.data?.error || e.message)
                        });
                    } finally {
                        isSending.value = false;
                        scrollToBottom();
                    }
                };

                const clearChat = () => {
                    if(confirm('Clear chat history?')) {
                        messages.value = [];
                    }
                };

                const scrollToBottom = () => {
                    nextTick(() => {
                        if (chatContainer.value) {
                            chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                        }
                    });
                };

                const formatTime = (isoString) => {
                    if (!isoString) return '';
                    return new Date(isoString).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                };

                const renderMarkdown = (text) => {
                    return md.render(text || '');
                };

                // Templates
                const templates = {
                    'Coder': {
                        name: 'Coder',
                        system_message: 'You are a skilled Python developer. You write clean, efficient code. When asked to write code, output the code in a code block.',
                        config: { description: 'Writes code to solve problems.', human_input_mode: 'NEVER', max_consecutive_auto_reply: 10, temperature: 0.2 }
                    },
                    'Product Manager': {
                        name: 'Product Manager',
                        system_message: 'You are a Product Manager. You analyze requirements, propose features, and ensure the product meets user needs.',
                        config: { description: 'Plans features and requirements.', human_input_mode: 'NEVER', max_consecutive_auto_reply: 10, temperature: 0.7 }
                    },
                    'Writer': {
                        name: 'Writer',
                        system_message: 'You are a creative writer. You write engaging content, blog posts, and stories.',
                        config: { description: 'Writes content.', human_input_mode: 'NEVER', max_consecutive_auto_reply: 10, temperature: 0.8 }
                    }
                };

                const toggleSelectAll = () => {
                    if (selectedAgentIds.value.length === agents.value.length) {
                        selectedAgentIds.value = [];
                    } else {
                        selectedAgentIds.value = agents.value.map(a => a.id);
                    }
                };

                const duplicateAgent = async (agent) => {
                    try {
                        await axios.post(`${API_BASE}/agents/${agent.id}/duplicate`);
                        showToast(`Agent ${agent.name} duplicated`, 'success');
                        fetchAgents();
                    } catch (e) {
                        showToast('Error duplicating agent: ' + e.message, 'error');
                    }
                };

                const applyTemplate = (tpl) => {
                    form.value.name = tpl.name;
                    form.value.system_message = tpl.system_message;
                    form.value.config = { ...tpl.config };
                };
                
                const handleKeydown = (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                };

                // Lifecycle
                onMounted(() => {
                    fetchAgents();
                });

                return {
                    currentTab,
                    agents,
                    selectedAgentIds,
                    messages,
                    userInput,
                    isSending,
                    loadingAgents,
                    isEditing,
                    form,
                    toast,
                    chatContainer,
                    templates,
                    // methods
                    fetchAgents,
                    openCreateModal,
                    editAgent,
                    closeModal,
                    saveAgent,
                    deleteAgent,
                    sendMessage,
                    clearChat,
                    formatTime,
                    renderMarkdown,
                    toggleSelectAll,
                    duplicateAgent,
                    applyTemplate,
                    handleKeydown
                };
            }
        }).mount('#app');
    </script>
</body>
</html>